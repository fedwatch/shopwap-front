<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>分类 - 街街网</title>
    <!--js 头部引入-->
    <meta charset="UTF-8">
    <meta content="telephone=no" name="format-detection"/>
    <meta name="apple-mobile-web-app-capable" content="yes"/>
    <meta name="apple-mobile-web-app-status-bar-style" content="black"/>
    <link rel="icon" href="../../assets/images/favicon.ico" type="image/x-icon"/>
    <link rel="stylesheet" href="../../css/common.css">
    <link rel="stylesheet" href="../../css/style.css">
    <link rel="stylesheet" href="../../css/page.css">

    <link rel="manifest" href="html/manifest/manifest.json">
    <script type="text/javascript" src="../../assets/plugin/jquery.min.js"></script>

    <script type="text/javascript" src="../../assets/plugin/iscroll.js"></script>
    <script type="text/javascript" src="../../assets/plugin/iscroll-probe.js"></script>
    <script type="text/javascript" src="../../assets/plugin/page.js"></script>
    <!--<script type="text/javascript" src="/www/assets/plugin/sea.js"></script>-->
    <!--<script type="text/javascript" src="/www/assets/plugin/seajs-text.js"></script>-->
    <link href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="../../assets/plugin/light7/dist/css/light7.css"/>
    <link rel="stylesheet" type="text/css" href="../../assets/plugin/light7/dist/css/light7-swiper.min.css"/>
    <script type="text/javascript" src="../../assets/plugin/light7/dist/js/light7.min.js"></script>
    <script type="text/javascript" src="../../assets/plugin/light7/dist/js/light7-swiper.min.js"></script>
    <script type="text/javascript" src="../../assets/plugin/light7/dist/js/light7-swipeout.js"></script>
    <script type="text/javascript" src="../../assets/plugin/handlebars-v1.3.0.js"></script>
    <script type="text/javascript" src="../../assets/plugin/idangerous.swiper.min.js"></script>

    <script type="text/javascript" src="../../js/utils/store.min.js"></script>
    <script type="text/javascript" src="../../js/utils/getCurrentPage.js"></script>
    <script type="text/javascript" src="../../js/utils/parseUrl.js"></script>
    <script type="text/javascript" src="../../js/config/siteUrl.js"></script>
    <script>
        $(function () {



            jQuery.support.cors = true;
            var username = store.get("username");
            var scroller = new IScroll('#productCategory', {click: iScrollClick()});

            function iScrollClick(){
                // workaround click bug iscroll #674
                if (/iPhone|iPad|iPod|Macintosh/i.test(navigator.userAgent)) return false;
                if (/Chrome/i.test(navigator.userAgent)) return (/Android/i.test(navigator.userAgent));
                if (/Silk/i.test(navigator.userAgent)) return false;
                if (/Android/i.test(navigator.userAgent)) {
                    var s=navigator.userAgent.substr(navigator.userAgent.indexOf('Android')+8,3);
                    return parseFloat(s[0]+s[3]) < 44 ? false : true}
            }


            getCurrentPage();
            initCategoryActive();

            //商品查询1
            function getProductInfo() {
                var categoryIdsHidden = $("#categoryId").val();
                var categorySubId = $("#categorySubId").val();
                var keyword = '';
                var pageNumber = '';
                var categoryIds = categoryIdsHidden + "," + categorySubId;
                var brandIds = '';
                var startPrice = '';
                var endPrice = '';
                var pageSize = '';

                var pageOp = $("#productCategory").page({
                    url: BASE_URL + PRODUCT_SITE_URLS.PRODUCT_SEARCH.URL,
                    param: {},
                    processResult: function (result) {
                        var html = "";
                        if (result.products != null) {
                            $.each(result.products, function (index, data) {
                                html += '<div class="col-50 productCategory" >' +
                                    '<a href="javascript:;"  data-id="' + data.id + '" class="external">' +
                                    '<div style="background: #fff;padding:0 0;margin: .25rem 0;width:100%;height:12rem;overflow: hidden;">' +
                                    '<img src="' + data.image + '" alt="" style="width:100%;height:7rem;overflow: hidden;">' +
                                    '<h4 class="product-title" style="padding:0 .25rem;font-size:.7rem;color:#000;">' + data.name + '</h4>' +
                                    '<span class="product-price-box" style="padding:0 .25rem;font-size:.5rem;color:#ff0000;">￥<span style="font-size:.65rem;">' + data.price + '</span>' + '</span>' + '<span class="product-buyer-number-box" style="font-size:.5rem;color:#999;">已有 <span>' + data.sales + '</span>人购买</span>' + '</div>' +
                                    '</a>' + '</div>';
                            });

                        }

                        return html;
                    }
                });
                pageOp.load({categoryIds: categoryIds});

            }

            function initCategoryActive() {
                $(".nav-tabbar-item").first().find(".nav-render > .nav-text").addClass("active");
                $(".nav-sub-text").first().addClass("active");
                var tabbarBottomline = $("#tabbar-bottomline");
                var textLen = $($('.nav-tabbar-item .nav-text')).eq(0).text().length;
                if (textLen == 4) {
                    tabbarBottomline.css("width", "5rem");
                } else if (textLen == 3) {
                    tabbarBottomline.css("width", "4rem");
                } else if (textLen == 2) {
                    tabbarBottomline.css("width", "3rem");
                }

            }

            // mainNav
            $.ajax({
                url: BASE_URL + PRODUCT_SITE_URLS.FIND_ROOTS.URL,
                type: PRODUCT_SITE_URLS.FIND_ROOTS.METHOD,
                dataType: "json",
                data: {username: username},
                cache: true,
                async: false,
                success: function (data) {
                    if (data.authStatus == "200") {
                        var template = Handlebars.compile($("#mainNavTpl").html());
                        var html = template(data);
                        $("#mainNav").html(html);

                        // navSubPosition
                        var categoryId = data.productCategories[0].id;
                        $.ajax({
                            url: BASE_URL + PRODUCT_SITE_URLS.FIND_SUBS.URL,
                            type: PRODUCT_SITE_URLS.FIND_SUBS.METHOD,
                            data: {username: username, id: categoryId},
                            dataType: PRODUCT_SITE_URLS.DATATYPE,
                            cache: true,
                            async: false,
                            success: function (data) {
                                if (data.authStatus == '200') {

                                    var template = Handlebars.compile($("#navSubPositionTpl").html());
                                    var html = template(data);
                                    $("#navSubPosition").html(html);

                                    var categoryIdsHidden = categoryId;
                                    var categorySubId = data.productCategories[0].id;
                                    var keyword = '';
                                    var pageNumber = '1';
                                    var categoryIds = categoryIdsHidden + "," + categorySubId;
                                    var brandIds = '';
                                    var startPrice = '';
                                    var endPrice = '';
                                    var pageSize = '20';
                                    getSearchResults(keyword, pageNumber, categoryIds, brandIds, startPrice, endPrice, pageSize, 'productCategory');

                                    initCategoryActive();

                                }
                            }
                        });
                    }
                }
            })

            //商品查询
            function getSearchResults(keyword, pageNumber, categoryIds, brandIds, startPrice, endPrice, pageSize, DOM) {
                var pageOp = $("#productCategory").page({
                    url: BASE_URL + PRODUCT_SITE_URLS.PRODUCT_SEARCH.URL,
                    param: {},
                    processResult: function (result) {
                        var html = "";
                        if (result.products != null) {
                            $.each(result.products, function (index, data) {
                                html += '<div class="col-50 productCategory" >' +
                                    '<a href="javascript:;"  data-id="' + data.id + '" class="external">' +
                                    '<div style="background: #fff;padding:0 0;margin: .25rem 0;width:100%;height:12rem;overflow: hidden;">' +
                                    '<img src="' + data.image + '" alt="" style="width:100%;height:7rem;overflow: hidden;">' +
                                    '<h4 class="product-title" style="padding:0 .25rem;font-size:.7rem;color:#000;">' + data.name + '</h4>' +
                                    '<span class="product-price-box" style="padding:0 .25rem;font-size:.5rem;color:#ff0000;">￥<span style="font-size:.65rem;">' + data.price + '</span>' + '</span>' + '<span class="product-buyer-number-box" style="font-size:.5rem;color:#999;">已有 <span>' + data.sales + '</span>人购买</span>' + '</div>' +
                                    '</a>' + '</div>';
                            });

                        }

                        return html;
                    }
                });

                pageOp.load({
                    keyword: keyword,
                    pageNumber: pageNumber,
                    categoryIds: categoryIds,
                    brandIds: brandIds,
                    startPrice: startPrice,
                    endPrice: endPrice,
                    pageSize: pageSize
                });
            }

            /**
             * 主分类
             */
            $(document).on('click', '.nav-tabbar-item .nav-text', function (e) {
                // e.preventDefault();
                var $this = $(this);
                $("#categoryId").val($this.data("category-id"));
                var w = $this.offset().left;
                $(".nav-tabbar-item .nav-text").removeClass("active");
                $this.addClass("active");
                var tabbarBottomline = $("#tabbar-bottomline");
                tabbarBottomline.css("transform", "translate3d(" + w + "px, 0px, 0px)");
                var textLen = $(this).text().length;
                if (textLen == 4) {
                    tabbarBottomline.css("width", "5rem");
                } else if (textLen == 3) {
                    tabbarBottomline.css("width", "4rem");
                } else if (textLen == 2) {
                    tabbarBottomline.css("width", "3rem");
                }

                //点击获取二级菜单
                $.ajax({
                    url: BASE_URL + PRODUCT_SITE_URLS.FIND_SUBS.URL,
                    dataType: PRODUCT_SITE_URLS.DATATYPE,
                    type: PRODUCT_SITE_URLS.FIND_SUBS.METHOD,
                    data: {username: username, id: $("#categoryId").val()},
                    async: false,
                    cache: true,
                    success: function (data) {
                        if (data.authStatus == "200") {
                            var template = Handlebars.compile($("#navSubPositionTpl").html());
                            var html = template(data);
                            $("#navSubPosition").html(html);
                            $("#categorySubId").val($this.data("category-sub-id"));
                            $(".nav-sub-text").first().addClass("active");
                        }
                        getProductInfo();
                    }
                });


            });
            //二级分类
            $(document).on('click', '.nav-sub-tabbar-item .nav-sub-text', function (e) {
                var $this = $(this);
                $(".nav-sub-render .nav-sub-text").removeClass("active");
                $this.addClass("active");
                $("#categorySubId").val($this.data("category-sub-id"));
                getProductInfo();

            });

            function getProductDetail(id) {
                var productId = id;
                store.set("currentProductID", productId);
                location.href = '../../html/detail/detail.html';
            }

            /**
             *
             */
            $(document).on('click', '.productCategory a', function (e) {
//           e.preventDefault();
                console.log("click,tap happened!");
                getProductDetail($(this).data("id"));
            });

            // footerNav
            var data = {};
            var template = Handlebars.compile($("#footerTpl").html());
            var html = template(data);
            $("#footerNavPage").html(html);

//            setTimeout(function () {
//
//            },800)


            setTimeout(function(){
                getParamsShow();
            },1000)



        })


        function getParamsShow(){
            var l = parseURL(location.href);
//            console.log(l.params)
            if(typeof l.params.length !== 'undefined'){
                //            console.log(l.params)
                if(location.protocol === 'http' || location.protocol === 'https'){
                    var categoryId = l.params.categoryId;
                    var left = $(document).find("span.nav-text[data-category-id="+categoryId+"]").offset().left;
                    console.log(left)
//                $(".nav-scrollview").scrollLeft("300")
                    $(document).find("span.nav-text[data-category-id="+categoryId+"]").click();
                }else{
//                console.log(l.source)
                    var res = l.source.split("=");
//                console.log(res)
                    var left = $(document).find("span.nav-text[data-category-id="+res[1]+"]").offset().left;
                    console.log(left)
                    $(".nav-scrollview").scrollLeft(left)
                    $(document).find("span.nav-text[data-category-id="+res[1]+"]").click();
                }
            }
        }

    </script>
</head>
<body>
<div id="categoryPage" class="mainList page">
    <div class="content ccSearch">
        <div class="appStatusBar" style="background:#fff"></div>
        <div class="categoryList list-block" style="">
            <div class="main-nav" id="mainNav"></div>
            <div class="nav-sub-position" id="navSubPosition"></div>
        </div>
        <div class="" style="position:absolute;width:100%;top:90px;bottom:50px;">
            <div id="productCategory">
                <div class="productContainer"></div>
            </div>
        </div>
    </div>

</div>
<div id="footerNavPage"></div>
<script type="text/x-handlebars-template" id="navSubPositionTpl">
    <!--二级商品分类-->
    <div class="nav-sub-tabs">
        <div class=" nav-sub-tabbar">
            <div class=" nav-sub-tabbar-itemlist">
                <div class=" nav-sub-scrollview">
                    {{#each productCategories}}
                    <div class="nav-sub-tabbar-item">
                        <div class="nav-sub-render">
                            <span class="nav-sub-text " data-category-sub-id="{{this.id}}">{{this.name}}</span>
                        </div>
                    </div>
                    {{/each}}
                </div>
            </div>
        </div>
    </div>
</script>
<script type="text/x-handlebars-template" id="mainNavTpl">
    <div class="nav-tabs">
        <div class="nav-tabbar">
            <div class="nav-tabbar-itemlist">
                <div class="nav-scrollview">
                    {{#each productCategories}}
                    <div class="nav-tabbar-item">
                        <div class="nav-render">
                            <span class="nav-text" data-category-id="{{this.id}}">{{this.name}}</span>
                        </div>
                    </div>
                    {{/each}}
                </div>
            </div>
        </div>
    </div>
    <div id="tabbar-bottomline" class="nav-tabbar-bottomline"></div>


    <input type="hidden" id="categoryId" value="105">
    <input type="hidden" id="categorySubId" value="">
</script>
<script type="text/x-handlebars-template" id="footerTpl">
    <!--现在的页脚-->
    <nav class="footer-bar bar bar-tab ">
        <a id="home-link" class="tab-item  external" href="../../index.html">
            <i class="icon icon-nav-home"></i>
            <span class="tab-label">首页</span>
        </a>
        <a id="category-link" class="tab-item external" href="../../html/category/category.html">
            <i class="icon icon-nav-category"></i>
            <span class="tab-label">分类</span>
        </a>
        <a id="cart-link" class="tab-item external" href="../../html/cart/cart.html">
            <i class="icon icon-nav-cart"></i>
            <span class="tab-label">购物车</span>
        </a>
        <a id="user-link" class="tab-item external" href="../../html/my/my.html">
            <i class="icon icon-nav-user"></i>
            <span class="tab-label">我的</span>
        </a>
    </nav>
</script>
</body>

</html>