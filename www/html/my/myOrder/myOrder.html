<!DOCTYPE html>
<html lang="en">
<head>
    <meta content="telephone=no" name="format-detection">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>我的订单 - 我的 - 街街网</title>
    <!--js 头部引入-->
    <meta charset="UTF-8">
    <meta content="telephone=no" name="format-detection"/>
    <meta name="apple-mobile-web-app-capable" content="yes"/>
    <meta name="apple-mobile-web-app-status-bar-style" content="black"/>
    <link rel="icon" href="../../../assets/images/favicon.ico" type="image/x-icon"/>
    <link rel="stylesheet" href="../../../css/common.css">
    <link rel="stylesheet" href="../../../css/style.css">
    <link rel="stylesheet" type="text/css" href="../../../assets/plugin/light7/dist/css/light7.css"/>
    <link rel="stylesheet" type="text/css" href="../../../assets/plugin/light7/dist/css/light7-swiper.min.css"/>
    <script type="text/javascript" src="../../../assets/plugin/jquery.min.js"></script>
    <script type="text/javascript" src="../../../assets/plugin/iscroll.js"></script>
    <script type="text/javascript" src="../../../assets/plugin/iscroll-probe.js"></script>
    <script type="text/javascript" src="../../../assets/plugin/page.js"></script>
    <script type="text/javascript" src="../../../assets/plugin/light7/dist/js/light7.min.js"></script>
    <script type="text/javascript" src="../../../assets/plugin/light7/dist/js/light7-swiper.min.js"></script>
    <script type="text/javascript" src="../../../assets/plugin/light7/dist/js/light7-swipeout.js"></script>
    <script type="text/javascript" src="../../../assets/plugin/handlebars-v1.3.0.js"></script>
    <script type="text/javascript" src="../../../js/config/siteUrl.js"></script>
    <script type="text/javascript" src="../../../js/utils/store.min.js"></script>
    <script type="text/javascript" src="../../../js/utils/transMyOrder.js"></script>
    <link href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!--<script type="text/javascript" src="../../../assets/plugin/sea.js"></script>-->
    <!--<script type="text/javascript" src="../../../assets/plugin/seajs-text.js"></script>-->

    <script>

        var reieverStatus;
        var username = store.get("username");
        $(function () {
            jQuery.support.cors = true;

            $.ajax({
                url: BASE_URL + ORDER_SITE_URL.LIST.URL,
                type: ORDER_SITE_URL.LIST.METHOD,
                dataType: ORDER_SITE_URL.DATATYPE,
                data: {
                    username: username,
                    orderStatus: 'all',
                    pageNumber: '1'
                },
                cache: true,
                async: false,
                success: function (data) {
                    if(data.authStatus === '200'){
                        var template = Handlebars.compile($("#myOrderTpl").html());
                        var html = template(data);
                        $("#myOrderPage").html(html);
                        $($(".ocItem")[0]).addClass("active");
                    }else if (data.authStatus === '403') {
                        $.toast(data.authMsg);
                        setTimeout(function(){
                            return location.href = '../login/login.html';
                        },1500)
                    }

                }
            });







            function getOrderLists(username,orderStatus,pageNumber){
                var pageOp = $("#getListOrders").page({
                    url: BASE_URL + ORDER_SITE_URL.LIST.URL,
                    param: {
                        username: username,
                        orderStatus: orderStatus,
                        pageNumber: pageNumber
                    },
                    processResult: function (data) {
                        console.log(data);
                        var html = '';
                        var template = Handlebars.compile($("#cartItemTpl").html());
                         html += template(data);
                         console.log(html)
                         return html;
                    }
                });
            }





            // 我的订单 全部 待付款 待发货 待收货 待评价
            $(document).on("click", ".ocItem", function () {
                var $this = $(this);
                $(".ocItem").removeClass("active");

                var all = $this.hasClass('all');
                var unconfirmed = $this.hasClass('unconfirmed');
                var confirmed = $this.hasClass('confirmed');
                var shipped = $this.hasClass('shipped');
                var completed = $this.hasClass('completed');


                if ($this.hasClass('all')) {
                    getListOrders(username, 'all', '1');
                } else if ($this.hasClass('unconfirmed')) {
                    getListOrders(username, 'unconfirmed', '1');
                } else if ($this.hasClass('confirmed')) {
                    getListOrders(username, 'confirmed', '1');
                } else if ($this.hasClass('shipped')) {
                    getListOrders(username, 'shipped', '1');
                } else if ($this.hasClass('completed')) {
                    getListOrders(username, 'completed', '1');
                }

                if (all) {
                    $(".ocItem.all").addClass("active");
                } else if (unconfirmed) {
                    $(".ocItem.unconfirmed").addClass("active");
                } else if (confirmed) {
                    $(".ocItem.confirmed").addClass("active");
                } else if (shipped) {
                    $(".ocItem.shipped").addClass("active");
                } else if (completed) {
                    $(".ocItem.completed").addClass("active");
                }


            });

            // 确认收货
            $(document).on('click', '.confirmReceiptBtn ', function () {
                var $this = $(this);
                console.log($this)
                var sn = $this.data('sn');

                orderComplete(username, [sn]);

                if (store.get("reieverStatus") == true) {
                    $this.text("已收货")
                } else {
                    $this.text("确认收货")
                }
            });

            // 查看物流
            $(document).on("click", ".checkLogBtn", function () {
                var $this = $(this);
                store.set("sn", $this.data("sn"));
                return location.href = '../../../html/user/logistics.html';

            });

            // 立即付款
            $(document).on("click", ".paymentBtn", function () {
                var $this = $(this);
                var sn = $this.data("sn");
                console.log(username);
                console.log(sn);
                createPayment(username, [sn]);
                store.set("mergeSn", mergeSn);

                return location.href = '../../../html/payment/alipay/commonPay.html';
            });

            // 立即评价
            $(document).on('click', ".commentBtn", function () {

            });

//            var scroller = new IScroll('#getListOrders', {disableMouse : true,click: iScrollClick(),tap: true,probeType: 3});
//
//            function iScrollClick(){
//                // workaround click bug iscroll #674
//                if (/iPhone|iPad|iPod|Macintosh/i.test(navigator.userAgent)) return false;
//                if (/Chrome/i.test(navigator.userAgent)) return (/Android/i.test(navigator.userAgent));
//                if (/Silk/i.test(navigator.userAgent)) return false;
//                if (/Android/i.test(navigator.userAgent)) {
//                    var s=navigator.userAgent.substr(navigator.userAgent.indexOf('Android')+8,3);
//                    return parseFloat(s[0]+s[3]) < 44 ? false : true}
//            }

        });

        var mergeSn;

        function createPayment(username, sn) {
            $.ajax({
                url: BASE_URL + ORDER_SITE_URL.CREATE_PAYMENT.URL,
                type: ORDER_SITE_URL.CREATE_PAYMENT.METHOD,
                dataType: ORDER_SITE_URL.DATATYPE,
                cache: true,
                async: false,
                data: {
                    username: username,
                    sn: sn,
                },
                success: function (data) {
                    mergeSn = data.mergeSn
                    console.log(mergeSn)
                }
            })
        }


        /**
         * 获取对应状态的订单
         * @param username
         * @param orderStatus   订单状态
         *
         全部:all
         待付款:unconfirmed
         待发货:confirmed
         待收货:shipped
         待评价:completed
         * @param pageNumber
         */
        function getListOrders(username, orderStatus, pageNumber) {
            $.ajax({
                url: BASE_URL + ORDER_SITE_URL.LIST.URL,
                type: ORDER_SITE_URL.LIST.METHOD,
                dataType: ORDER_SITE_URL.DATATYPE,
                data: {
                    username: username,
                    orderStatus: orderStatus,
                    pageNumber: pageNumber
                },
                cache: true,
                async: false,
                success: function (data) {
//                    var tpl = require('/zqVue/shopwap-front/www/layout/my/orderData.tpl');
                    var template = Handlebars.compile($("#orderDataTpl").html());
                    var html = template(data);
                    $("#getListOrders").html(html);
                }
            })
        }

        /**
         *
         * @param username
         * @param sn
         */
        function orderComplete(username, sn) {
            $.ajax({
                url: BASE_URL + ORDER_SITE_URL.COMPLETE.URL,
                type: ORDER_SITE_URL.COMPLETE.METHOD,
                dataType: ORDER_SITE_URL.DATATYPE,
                data: {
                    username: username,
                    sn: sn
                },
                cache: true,
                async: false,
                success: function (data) {
                    if (data.authStatus == '200') {
                        store.set("reieverStatus", true);
                        $.toast(data.authMsg);
                    } else {
                        store.set("reieverStatus", false);
                        $.toast(data.authMsg)
                    }

                }
            })
        }


        function getSearchResults(keyword, pageNumber, categoryIds, brandIds, startPrice, endPrice, pageSize, DOM) {
            var pageOp = $("#productCategory").page({
                url: BASE_URL + PRODUCT_SITE_URLS.PRODUCT_SEARCH.URL,
                param: {
                    keyword: keyword,
                    pageNumber: pageNumber,
                    categoryIds: categoryIds,
                    brandIds: brandIds,
                    startPrice: startPrice,
                    endPrice: endPrice,
                    pageSize: pageSize
                },
                processResult: function (data) {
                    var html = "";
                    if (data.products != null) {
                        $.each(data.products, function (index, data) {
                            html += '<div class="col-50 productCategory" >' +
                                '<a href="javascript:;"  data-id="' + data.id + '" class="external">' +
                                '<div class="productWindow" >' +
                                '<img src="' + data.image + '" alt="'+data.name+'" title="'+data.name+'" >' +
                                '<h4 class="product-title">' + data.name + '</h4>' +
                                '<span class="product-price-box" >￥<span style="font-size:.65rem;">' + data.price + '</span>' + '</span>' +
                                '<span class="product-buyer-number-box" >已有 <span>' + data.sales + '</span>人购买</span>' + '</div>' +
                                '</a>' + '</div>';
                        });

                    }

                    return html;
                }
            });
//                pageOp.load();
        }


    </script>
</head>
<body>
<div id="myOrderPage" class="page jjPageBg"></div>

<script type="text/x-handlebars-template" id="orderDataTpl">

    {{#if orders}}
    {{#each orders}}
    <div class="cart-item">
        <div class="cart-store-title-label">
            <span class="pull-left storeName"><i
                    class="icon icon-store-icon"></i> {{this.bizSupplierInfo.shopName}}</span>
            <span class="pull-right tradeStatus"> {{transOrderStatus this.orderStatus}} </span>
        </div>
        {{#each orderItems}}
        <div class="cart-store-img-text-label">
            <div class="cart-item-image">
                {{#if this.thumbnail}}
                <img src="{{this.thumbnail}}" alt="" style="">
                {{else}}
                <img src="../../../assets/images/default-photo-m.jpg" alt="" style="">
                {{/if}}
            </div>
            <div class="cart-item-text">
                <div class="row">
                    <div class="col-66">
                        <h2 class="cart-item-buying-title">{{this.fullName}}</h2>
                        <span class="cart-item-buying-desc">{{this.product.specificationValues.description}}</span>
                    </div>

                    <div class="priceWrapper col-33">
                        <span class="nowPrice">￥ {{this.product.price}}</span><br>
                        <del class="pastPrice">￥ {{this.product.marketPrice}}</del>
                        <br>
                        <span>x <span class="quant">{{quantity}}</span></span>
                    </div>
                </div>

            </div>

        </div>

        <div class="totalBox">
            共 <span class="totalQuant">{{this.quantity}}</span> 件商品 合计：￥<span
                class="totalPrice">{{this.subtotal}}</span> (含运费 ￥<span class="logPrice">{{this.freight}}</span>)
        </div>
        {{/each}}


        <div class="userChooseCol">

            {{#compare this.orderStatus 'shipped'}}
            <a href="javascript:void(0);" class="external checkLogBtn uccButton" data-sn="{{sn}}"> 查看物流 </a>
            <span class="confirmReceiptBtn uccButton" data-sn="{{sn}}"> 确认收货 </span>
            {{/compare}}

            {{#compare this.orderStatus 'completed'}}
            <a href="../../../html/user/logistics.html" class="external checkLogBtn uccButton" data-sn="{{sn}}">
                查看物流 </a>
            <!--<a href="/html/user/review.html" class="external commentBtn uccButton" data-sn="{{sn}}"> 评价 </a>-->
            {{/compare}}

            {{#compare this.orderStatus 'unconfirmed'}}
            <a href="javascript:void(0);" class="external paymentBtn uccButton" data-sn="{{sn}}"> 立即付款 </a>
            {{/compare}}

            {{#compare this.orderStatus 'confirmed'}}
            <a href="javascript:void(0);" class="waitSendBtn uccButton"> 等待卖家发货 </a>
            {{/compare}}

            {{#compare this.orderStatus 'closed'}}
            <a href="javascript:void(0);" class="waitSendBtn uccButton"> 交易关闭 </a>
            {{/compare}}

            {{#compare this.orderStatus 'expired'}}
            {{/compare}}
        </div>
    </div>
    {{/each}}
    {{else}}
    <div class="cart-item text-center" style="padding:2.35rem 0">
        <img src="../../../assets/images/noOrder.png" alt="">
        <p>还没有任何订单呢</p>
    </div>

    {{/if}}


</script>

<script type="text/x-handlebars-template" id="myOrderTpl">
    <div class="appStatusBar" style="background:#fff;"></div>
    <!--我的订单-->
    <header class="bar bar-nav">
        <a class="button button-link button-nav pull-left external" href="javascript:history.go(-1)"
           data-transition='slide-out'>
            <i class="fa fa-chevron-left"></i>
        </a>
        <h1 class='title'>我的订单</h1>
    </header>

    <div class="content">
        <div class="appStatusBar"></div>

        <div class="orderColumn" style="width:100%;">
            <div class="row text-center ">
                <div class="col-20 ocItem all">
                    <span>全部</span>
                </div>
                <div class="col-20 ocItem unconfirmed">
                    <span>待付款</span>
                </div>
                <div class="col-20 ocItem confirmed">
                    <span>待发货</span>
                </div>
                <div class="col-20 ocItem shipped">
                    <span>待收货</span>
                </div>
                <div class="col-20 ocItem completed">
                    <span>待评价</span>
                </div>
            </div>
        </div>

        <div id="getListOrders" class="myOrderList list-block">
            {{#if orders}}
            {{#each orders}}
            <div class="cart-item">
                <div class="cart-store-title-label">
                    <span class="pull-left storeName"><i class="icon icon-store-icon"></i> {{this.bizSupplierInfo.shopName}}</span>
                    <span class="pull-right tradeStatus"> {{transOrderStatus this.orderStatus}} </span>
                </div>
                {{#each orderItems}}
                <div class="cart-store-img-text-label">
                    <div class="cart-item-image">
                        {{#if this.thumbnail}}
                        <img src="{{this.thumbnail}}" alt="" style="">
                        {{else}}
                        <img src="../../../assets/images/default-photo-m.jpg" alt="" style="">
                        {{/if}}
                    </div>
                    <div class="cart-item-text">
                        <div class="row">
                            <div class="col-66">
                                <h2 class="cart-item-buying-title">{{this.fullName}}</h2>
                                <span class="cart-item-buying-desc">{{this.product.specificationValues.description}}</span>
                            </div>

                            <div class="priceWrapper col-33">
                                <span class="nowPrice">￥ {{this.product.price}}</span><br>
                                <del class="pastPrice">￥ {{this.product.marketPrice}}</del>
                                <br>
                                <span>x <span class="quant">{{quantity}}</span></span>
                            </div>
                        </div>

                    </div>

                </div>
                <div class="totalBox">
                    共 <span class="totalQuant">{{this.quantity}}</span> 件商品 合计：￥<span class="totalPrice">{{this.subtotal}}</span>
                    (含运费 ￥<span class="logPrice">{{this.freight}}</span>)
                </div>
                {{/each}}
                <div class="userChooseCol">

                    {{#compare this.orderStatus 'shipped'}}
                    <a href="javascript:void(0);" class="external checkLogBtn uccButton" data-sn="{{sn}}"> 查看物流 </a>
                    <span class="confirmReceiptBtn uccButton" data-sn="{{sn}}"> 确认收货 </span>
                    {{/compare}}

                    {{#compare this.orderStatus 'completed'}}
                    <a href="../../user/logistics.html" class="external checkLogBtn uccButton" data-sn="{{sn}}">
                        查看物流 </a>
                    <!--<a href="m/html/user/review.html" class="external commentBtn uccButton" data-sn="{{sn}}"> 评价 </a>-->
                    {{/compare}}

                    {{#compare this.orderStatus 'unconfirmed'}}
                    <a href="javascript:void(0)" class="external paymentBtn uccButton" data-sn="{{sn}}"> 立即付款 </a>
                    {{/compare}}

                    {{#compare this.orderStatus 'confirmed'}}
                    <a href="javascript:void(0);" class="waitSendBtn uccButton"> 等待卖家发货 </a>
                    {{/compare}}

                    {{#compare this.orderStatus 'closed'}}
                    <a href="javascript:void(0);" class="waitSendBtn uccButton"> 交易关闭 </a>
                    {{/compare}}

                    {{#compare this.orderStatus 'expired'}}
                    {{/compare}}
                </div>
            </div>
            {{/each}}
            {{else}}

            {{/if}}
        </div>
    </div>

</script>

<script type="text/x-handlebars-template" id="cartItemTpl">
    {{#if orders}}
    {{#each orders}}
    <div class="cart-item">
        <div class="cart-store-title-label">
            <span class="pull-left storeName"><i class="icon icon-store-icon"></i> {{this.bizSupplierInfo.shopName}}</span>
            <span class="pull-right tradeStatus"> {{transOrderStatus this.orderStatus}} </span>
        </div>
        {{#each orderItems}}
        <div class="cart-store-img-text-label">
            <div class="cart-item-image">
                {{#if this.thumbnail}}
                <img src="{{this.thumbnail}}" alt="" style="">
                {{else}}
                <img src="../../../assets/images/default-photo-m.jpg" alt="" style="">
                {{/if}}
            </div>
            <div class="cart-item-text">
                <div class="row">
                    <div class="col-66">
                        <h2 class="cart-item-buying-title">{{this.fullName}}</h2>
                        <span class="cart-item-buying-desc">{{this.product.specificationValues.description}}</span>
                    </div>

                    <div class="priceWrapper col-33">
                        <span class="nowPrice">￥ {{this.product.price}}</span><br>
                        <del class="pastPrice">￥ {{this.product.marketPrice}}</del>
                        <br>
                        <span>x <span class="quant">{{quantity}}</span></span>
                    </div>
                </div>

            </div>

        </div>
        <div class="totalBox">
            共 <span class="totalQuant">{{this.quantity}}</span> 件商品 合计：￥<span class="totalPrice">{{this.subtotal}}</span>
            (含运费 ￥<span class="logPrice">{{this.freight}}</span>)
        </div>
        {{/each}}
        <div class="userChooseCol">

            {{#compare this.orderStatus 'shipped'}}
            <a href="javascript:void(0);" class="external checkLogBtn uccButton" data-sn="{{sn}}"> 查看物流 </a>
            <span class="confirmReceiptBtn uccButton" data-sn="{{sn}}"> 确认收货 </span>
            {{/compare}}

            {{#compare this.orderStatus 'completed'}}
            <a href="../../user/logistics.html" class="external checkLogBtn uccButton" data-sn="{{sn}}">
                查看物流 </a>
            <!--<a href="m/html/user/review.html" class="external commentBtn uccButton" data-sn="{{sn}}"> 评价 </a>-->
            {{/compare}}

            {{#compare this.orderStatus 'unconfirmed'}}
            <a href="javascript:void(0)" class="external paymentBtn uccButton" data-sn="{{sn}}"> 立即付款 </a>
            {{/compare}}

            {{#compare this.orderStatus 'confirmed'}}
            <a href="javascript:void(0);" class="waitSendBtn uccButton"> 等待卖家发货 </a>
            {{/compare}}

            {{#compare this.orderStatus 'closed'}}
            <a href="javascript:void(0);" class="waitSendBtn uccButton"> 交易关闭 </a>
            {{/compare}}

            {{#compare this.orderStatus 'expired'}}
            {{/compare}}
        </div>
    </div>
    {{/each}}
    {{else}}

    {{/if}}
</script>
</body>
</html>